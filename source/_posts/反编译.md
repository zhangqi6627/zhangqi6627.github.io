---
title: 反编译
date: 2018-03-08 12:52:28
tags:
---
apktool是跨平台的工具，可以再windows平台和ubuntu平台下直接使用。使用前到http://code.google.com/p/android-apktool/ 下载apktool,解压后可以将其添加到系统的环境变量中，以便在命令行下直接使用

## 反编译
> 
反编译apk文件的命令:apktool d[ecode] [OPTS] <file.apk> [<dir>]			如:apktool d FlashLight.apk
反编译整个包:包括smali文件和资源文件
反编译成jar包:./dex2jar/dex2jar.sh HelloActivity.apk		然后用jd-gui工具打开
反编译apk文件成功后，会在当前目录下生成一个文件夹，如:FlashLight
./decode.sh -v HelloActivity.apk		//也可以使用一键反编译脚本（王鹏作）

## 打包
重新打包apk文件的命令为:apktool b[uild] [OPTS] [<app_path>] [<out_file>]		如:apktool b SetupWizard	
需要将aapt添加到环境变量中，否则会提示aapt无法执行，编译出错 	
注:添加环境变量，打开~/.bashrc 添加如下:export PATH=/home/zq/tools/eclipse_and_sdk/android-sdk-linux/platform-tools:$PATH

## 签名
重新编译apk之后还需要对apk进行签名，否则会安装不了
/home/zq/.android/debug.keystore			//Eclipse默认签名，在Eclipse->Window->Android->Build 中可以查看 Default debug keystore
#### 未签名直接安装
```
adb install HelloActivity.apk 
259 KB/s (11371 bytes in 0.042s)
    pkg: /data/local/tmp/HelloActivity.apk
Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES]
```

#### 签名
```
./dex2jar/d2j-apk-sign.sh -w ./HelloActivity/dist/HelloActivity.apk			
sign ./HelloActivity/dist/HelloActivity.apk -> HelloActivity-signed.apk
```

#### 签名之后安装
```
adb install HelloActivity-signed.apk 
300 KB/s (14705 bytes in 0.047s)
    pkg: /data/local/tmp/HelloActivity-signed.apk
Success
```

## 用eclipse+ADT方式签名
a) 调试签名
eclipse插件默认赋予程序一个DEBUG权限的签名，此签名的程序不能发布到market上，此签名有效期为一年，如果过期则导致无法生成apk文件，此时你只要删除debug keystore即可，系统又会为你生成有效期为一年的新签名
b) 开发者生成密钥并签名
右键点击项目名，在菜单中选择Android Tools，然后选择Export Signed Application Package，即可通过eclipse自定义证书并签名
c) 开发者导出未签名的包
右键点击项目名，在菜单中选择Android Tools，然后选择Export UnSigned Application Package，即可导出未签名的包，之后可通过命令行方式签名

> 
签名的相关问题
一般在安装时提示出错:INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES
1) 两个应用，名字相同，签名不同
2) 升级时前一版本签名，后一版本没签名
3) 升级时前一版本为DEBUG签名，后一个为自定义签名
4) 升级时前一版本为Android源码中的签名

更详细的介绍可以参考文档	《Android软件安全与逆向分析.pdf》

例子:
Bug:Google向导会将灭屏时间设置为121000
SetupWizard_default_dark.apk
反编译出smali文件之后

```
grep "screen_off_timeout" ./ -r
./smali/com/google/android/setupwizard/BaseActivity.smali:    const-string v2, "screen_off_timeout"
./smali/com/google/android/setupwizard/BaseActivity.smali:    const-string v2, "screen_off_timeout"
./smali/com/google/android/setupwizard/BaseActivity.smali:    const-string v3, "screen_off_timeout"
./smali/com/google/android/setupwizard/BaseActivity.smali:    const-string v1, "screen_off_timeout"
```

然后同过jd-gui查看BaseActivity.java文件
``` Java
protected void onSetupStart() {
	mUserData.put("screenTimeout", Integer.valueOf(Settings.System.getInt(getContentResolver(), "screen_off_timeout", 121000)));
	Settings.System.putInt(getContentResolver(), "screen_off_timeout", 121000);
	if (ROTATION_LOCKED){
		lockRotation();
	}
}
```