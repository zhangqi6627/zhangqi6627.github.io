---
title: 添加水印效果
date: 2017-09-22 09:44:20
tags:
---
#### a.新建一个名为setup.conf的文件
写入以下内容:B79A939390%20
这个字符串就是hello,从 createWatermarkInTransaction() 这个代码中可以看出
然后把这个conf文件push到手机的system/etc目录下

#### b.以加水印字串“hello world,this is my mark”为例
修改 : WaterMark.java(frameworks/base/services/java/com/android/server/wm)文件,
注释掉WaterMark构造函数中的这一句:
``` Java
mText = builder.toString();
```
加上这一句:
``` Java
mText = "xxx";  //xxx表示你想要加为水印的字符串
```

#### c.重新编译生成services.jar文件并push到手机的system/framework下, reboot手机.

//frameworks/base/services/java/com/android/server/wm/WindowManagerService.java
``` Java
void createWatermarkInTransaction() {
    if (mWatermark != null) {
        return;
    }
    File file = new File("/system/etc/setup.conf");			//读取setup.conf文件
    FileInputStream in = null;
    DataInputStream ind = null;
    try {
        in = new FileInputStream(file);
        ind = new DataInputStream(in);
        String line = ind.readLine();
        if (line != null) {
            String[] toks = line.split("%");
            if (toks != null && toks.length > 0) {
                mWatermark = new Watermark(getDefaultDisplayContentLocked().getDisplay(), mRealDisplayMetrics, mFxSession, toks);
            }
        }
    } catch (FileNotFoundException e) {
    } catch (IOException e) {
    } finally {
        if (ind != null) {
            try {
                ind.close();
            } catch (IOException e) {
            }
        } else if (in != null) {
            try {
                in.close();
            } catch (IOException e) {
            }
        }
    }
}
```
