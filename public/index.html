<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="王大可的茅草房">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="王大可的茅草房">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="王大可的茅草房">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>王大可的茅草房</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">王大可的茅草房</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Startseite</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archiv</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/26/排序的时候出现的问题Comparison-method-violates-its-general-contract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/26/排序的时候出现的问题Comparison-method-violates-its-general-contract/" itemprop="url">
                  排序的时候出现的问题Comparison method violates its general contract!
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-26 10:09:56 / Updated at: 16:37:14" itemprop="dateCreated datePublished" datetime="2018-04-26T10:09:56+08:00">2018-04-26</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题：排序的时候出现的问题Comparison-method-violates-its-general-contract"><a href="#问题：排序的时候出现的问题Comparison-method-violates-its-general-contract" class="headerlink" title="问题：排序的时候出现的问题Comparison method violates its general contract!"></a>问题：排序的时候出现的问题Comparison method violates its general contract!</h1><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Collections.sort(list, <span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> o1 &gt; o2 ? <span class="number">1</span> : -<span class="number">1</span>;<span class="comment">// 错误的方式  </span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>先说如何解决，解决方式有两种。</p>
<h3 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h3><p>上面代码写的本身就有问题，第4行没有考虑o1 == o2的情况，再者说我们不需要自己去比较，修改为如下代码即可：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Collections.sort(list, <span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;  </div><div class="line">        <span class="comment">// return o1 &gt; o2 ? 1 : -1;  </span></div><div class="line">        <span class="keyword">return</span> o1.compareTo(o2);<span class="comment">// 正确的方式  </span></div><div class="line">    &#125;  </div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="不修改代码"><a href="#不修改代码" class="headerlink" title="不修改代码"></a>不修改代码</h3><p>那么问题来了。为什么上面代码在JDK6中运行无问题，而在JDK7中却会抛异常呢？这是因为JDK7底层的排序算法换了，如果要继续使用JDK6的排序算法，可以在JVM的启动参数中加入如下参数：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Djava.util.Arrays.useLegacyMergeSort=<span class="keyword">true</span></div></pre></td></tr></table></figure></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>在我以前的认知中，高版本的JDK是可以兼容之前的代码的，与同事讨论了一番另加搜索了一番，事实证明，JDK6到JDK7确实存在兼容问题（不兼容列表）。在不兼容列表中我们可以找到关于Collections.sort的不兼容说明，如下：<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Area: API: Utilities  </div><div class="line">Synopsis: Updated sort behavior for Arrays and Collections may throw an IllegalArgumentException  </div><div class="line">Description: The sorting algorithm used by java.util.Arrays.sort and (indirectly) by java.util.Collections.sort has been replaced.   </div><div class="line">The new sort implementation may throw an IllegalArgumentException if it detects a Comparable that violates the Comparable contract.   </div><div class="line">The previous implementation silently ignored such a situation.  </div><div class="line">If the previous behavior is desired, you can use the new system property, java.util.Arrays.useLegacyMergeSort,   </div><div class="line">to restore previous mergesort behavior.  </div><div class="line">Nature of Incompatibility: behavioral  </div><div class="line">RFE: 6804124</div></pre></td></tr></table></figure></p>
<p>描述的意思是说，java.util.Arrays.sort(java.util.Collections.sort调用的也是此方法)方法中的排序算法在JDK7中已经被替换了。如果违法了比较的约束新的排序算法也许会抛出llegalArgumentException异常。JDK6中的实现则忽略了这种情况。</p>
<p>再回过头来看我们开篇有问题的实现：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> x &gt; y ? <span class="number">1</span> : -<span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<p>当x == y时，sgn(compare(x, y))  = -1，-sgn(compare(y, x)) = 1，这违背了sgn(compare(x, y)) == -sgn(compare(y, x))约束，所以在JDK7中抛出了本文标题的异常。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>那么现在是否可以盖棺定论了，按照上面的分析来看，使用这种比较方式（return x &gt; y ? 1 : -1;），只要集合或数组中有相同的元素，就会抛出本文标题的异常。实则不然，什么情况下抛出异常，还取决于JDK7底层排序算法的实现，也就是大名鼎鼎的TimSort。后面文章会分析TimSort。本文给出一个会引发该异常的Case，以便有心人共同研究，如下：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Integer[] array =   </div><div class="line">&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,   </div><div class="line"><span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">3</span>&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h2><p>在输入法中选择多中语言的键盘之后，到短信或其他编辑界面上长按空格切换输入法，会发现报错重启，抓log之后发现是 Comparison method violates its general contract 的错误。</p>
<h3 id="修改一"><a href="#修改一" class="headerlink" title="修改一"></a>修改一</h3><p>alps/frameworks/base/core/java/com/android/internal/inputmethod/InputMethodSubtypeSwitchingController.java<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.setProperty(<span class="string">"java.util.Arrays.useLegacyMergeSort"</span>, <span class="string">"true"</span>);</div></pre></td></tr></table></figure></p>
<p>在代码中动态设置 java.util.Arrays.useLegacyMergeSort 这个值的属性，发现没有效果。</p>
<h3 id="修改二"><a href="#修改二" class="headerlink" title="修改二"></a>修改二</h3><p>alps/frameworks/base/core/java/com/android/internal/inputmethod/InputMethodSubtypeSwitchingController.java<br>查看代码发现主要是对 ImeSubtypeListItem 这个类的集合进行排序，而 ImeSubtypeListItem 本身就实现了 Comparable 排序的方法：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImeSubtypeListItem</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">ImeSubtypeListItem</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> CharSequence mImeName;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> CharSequence mSubtypeName;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> InputMethodInfo mImi;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> mSubtypeId;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mIsSystemLocale;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mIsSystemLanguage;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImeSubtypeListItem</span><span class="params">(CharSequence imeName, CharSequence subtypeName,</span></span></div><div class="line"><span class="function"><span class="params">            InputMethodInfo imi, <span class="keyword">int</span> subtypeId, String subtypeLocale, String systemLocale)</span> </span>&#123;</div><div class="line">        mImeName = imeName;</div><div class="line">        mSubtypeName = subtypeName;</div><div class="line">        mImi = imi;</div><div class="line">        mSubtypeId = subtypeId;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(subtypeLocale)) &#123;</div><div class="line">            mIsSystemLocale = <span class="keyword">false</span>;</div><div class="line">            mIsSystemLanguage = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mIsSystemLocale = subtypeLocale.equals(systemLocale);</div><div class="line">            <span class="keyword">if</span> (mIsSystemLocale) &#123;</div><div class="line">                mIsSystemLanguage = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> Use Locale#getLanguage or Locale#toLanguageTag</span></div><div class="line">                <span class="keyword">final</span> String systemLanguage = parseLanguageFromLocaleString(systemLocale);</div><div class="line">                <span class="keyword">final</span> String subtypeLanguage = parseLanguageFromLocaleString(subtypeLocale);</div><div class="line">                mIsSystemLanguage = systemLanguage.length() &gt;= <span class="number">2</span> &amp;&amp;</div><div class="line">                        systemLanguage.equals(subtypeLanguage);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Returns the language component of a given locale string.</span></div><div class="line"><span class="comment">     * <span class="doctag">TODO:</span> Use &#123;<span class="doctag">@link</span> Locale#getLanguage()&#125; instead.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">parseLanguageFromLocaleString</span><span class="params">(<span class="keyword">final</span> String locale)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> idx = locale.indexOf(<span class="string">'_'</span>);</div><div class="line">        <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> locale;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> locale.substring(<span class="number">0</span>, idx);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(ImeSubtypeListItem other)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mImeName)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(other.mImeName)) &#123;</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!TextUtils.equals(mImeName, other.mImeName)) &#123;</div><div class="line">            <span class="keyword">return</span> mImeName.toString().compareTo(other.mImeName.toString());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (TextUtils.equals(mSubtypeName, other.mSubtypeName)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mIsSystemLocale) &#123;</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (other.mIsSystemLocale) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mIsSystemLanguage) &#123;</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (other.mIsSystemLanguage) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mSubtypeName)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(other.mSubtypeName)) &#123;</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mSubtypeName.toString().compareTo(other.mSubtypeName.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"ImeSubtypeListItem&#123;"</span></div><div class="line">                + <span class="string">"mImeName="</span> + mImeName</div><div class="line">                + <span class="string">" mSubtypeName="</span> + mSubtypeName</div><div class="line">                + <span class="string">" mSubtypeId="</span> + mSubtypeId</div><div class="line">                + <span class="string">" mIsSystemLocale="</span> + mIsSystemLocale</div><div class="line">                + <span class="string">" mIsSystemLanguage="</span> + mIsSystemLanguage</div><div class="line">                + <span class="string">"&#125;"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (o == <span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ImeSubtypeListItem) &#123;</div><div class="line">            <span class="keyword">final</span> ImeSubtypeListItem that = (ImeSubtypeListItem)o;</div><div class="line">            <span class="keyword">if</span> (!Objects.equals(<span class="keyword">this</span>.mImi, that.mImi)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.mSubtypeId != that.mSubtypeId) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改了 compareTo() 方法之后，还是没有效果，可能是我修改的方法不对，在compareTo() 方法中打log发现没有走到里面的方法。</p>
<h3 id="修改三"><a href="#修改三" class="headerlink" title="修改三"></a>修改三</h3><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;ImeSubtypeListItem&gt; <span class="title">getSortedInputMethodAndSubtypeList</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> includeAuxiliarySubtypes, <span class="keyword">boolean</span> isScreenLocked)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//------------modified begin-------------</span></div><div class="line">    System.setProperty(<span class="string">"java.util.Arrays.useLegacyMergeSort"</span>, <span class="string">"true"</span>);</div><div class="line">    <span class="comment">//Collections.sort(imList);</span></div><div class="line">    Collections.sort(imList, <span class="keyword">new</span> Comparator&lt;ImeSubtypeListItem&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(ImeSubtypeListItem arg0, ImeSubtypeListItem arg1)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (arg0 == <span class="keyword">null</span> &amp;&amp; arg1 == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (arg0 == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (arg1 == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// ImeName</span></div><div class="line">            <span class="keyword">if</span> (arg0.mImeName == <span class="keyword">null</span> &amp;&amp; arg1.mImeName == <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(arg0.mImeName)) &#123;</div><div class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(arg1.mImeName)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            String mImeName0 = arg0.mImeName.toString().trim();</div><div class="line">            String mImeName1 = arg1.mImeName.toString().trim();</div><div class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(mImeName0)) &#123;</div><div class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(mImeName1)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!TextUtils.equals(mImeName0, mImeName1)) &#123;</div><div class="line">                <span class="keyword">return</span> mImeName0.compareTo(mImeName1);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// SubtypeName</span></div><div class="line">            <span class="keyword">if</span> (arg0.mSubtypeName == <span class="keyword">null</span> &amp;&amp; arg1.mSubtypeName == <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(TextUtils.isEmpty(arg0.mSubtypeName))&#123;</div><div class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(TextUtils.isEmpty(arg1.mSubtypeName))&#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            String mSubtypeName0 = arg0.mSubtypeName.toString().trim();</div><div class="line">            String mSubtypeName1 = arg1.mSubtypeName.toString().trim();</div><div class="line">            <span class="keyword">if</span>(TextUtils.equals(mSubtypeName0, mSubtypeName1))&#123;</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> mSubtypeName0.compareTo(mSubtypeName1);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//------------modified end-------------</span></div><div class="line">    <span class="keyword">return</span> imList;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终通过把 Collections.sort(imList); 替换为 Collections.sort(imList, new Comparator<imesubtypelistitem>() 方法之后验证生效。</imesubtypelistitem></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/26/设置状态栏的颜色/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/26/设置状态栏的颜色/" itemprop="url">
                  设置状态栏的颜色
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-26 08:48:26 / Updated at: 09:56:09" itemprop="dateCreated datePublished" datetime="2018-04-26T08:48:26+08:00">2018-04-26</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>方法定义：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setStatusBarColor</span><span class="params">(Activity activity, <span class="keyword">int</span> statusColor)</span> </span>&#123;</div><div class="line">    Window window = activity.getWindow();</div><div class="line">    window.clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS);</div><div class="line">    window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);</div><div class="line">    window.getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_VISIBLE);</div><div class="line">    window.setStatusBarColor(statusColor);</div><div class="line">    ViewGroup mContentView = (ViewGroup) window.findViewById(Window.ID_ANDROID_CONTENT);</div><div class="line">    View mChildView = mContentView.getChildAt(<span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (mChildView != <span class="keyword">null</span>) &#123;</div><div class="line">        ViewCompat.setFitsSystemWindows(mChildView, <span class="keyword">false</span>);</div><div class="line">        ViewCompat.requestApplyInsets(mChildView);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>方法调用：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttachedToWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onAttachedToWindow();</div><div class="line">    <span class="keyword">if</span>(<span class="string">"com.android.settings.Settings"</span>.equalsIgnoreCase(getClass().getName()))&#123;</div><div class="line">        setStatusBarColor(SettingsActivity.<span class="keyword">this</span>, android.graphics.Color.parseColor(<span class="string">"#3A96FE"</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意: setStatusBarColor() 方法在onCreate()和onResume()中调用都是不起作用的，最好在onAttachedToWindow()方法中调用</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/25/insufficient-permissions-for-device/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/25/insufficient-permissions-for-device/" itemprop="url">
                  insufficient permissions for device
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-25 09:20:29 / Updated at: 09:26:05" itemprop="dateCreated datePublished" datetime="2018-04-25T09:20:29+08:00">2018-04-25</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>问题4: error: insufficient permissions for device（解决adb shell问题）</p>
<p>解决方法:<br>在linux下连接手机usb，试用adb shell时出现error: insufficient permissions for device，</p>
<p>而且我们输入adb devices显示：<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">xxxx@xxxx-pt:~$ adb devices</div><div class="line">List of devices attached </div><div class="line">????????????    device</div></pre></td></tr></table></figure></p>
<p>那么我们怎么解决它呢？</p>
<p>首先在终端查看usb的ID，输入lsusb命令，我们可以看到我们刚插如usb的ID号，如：</p>
<figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">xxxx@xxxx-pt:~$ lsusb</div><div class="line">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</div><div class="line">Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</div><div class="line">Bus 001 Device 002: ID 8087:0020 Intel Corp. Integrated Rate Matching Hub</div><div class="line">Bus 002 Device 002: ID 8087:0020 Intel Corp. Integrated Rate Matching Hub</div><div class="line">Bus 001 Device 003: ID 0461:4d80 Primax Electronics, Ltd </div><div class="line">Bus 001 Device 004: ID 1c7a:0801 LighTuning Technology Inc. Fingerprint Reader</div><div class="line">Bus 002 Device 003: ID 5986:0190 Acer, Inc </div><div class="line">Bus 001 Device 019: ID 0bb4:0c02 High Tech Computer Corp. Dream / ADP1 / G1 / Magic / Tattoo (Debug)</div></pre></td></tr></table></figure>
<p>0bb4:0c02 的就是我们插入usb的ID号。<br>那么我们进入到cd /etc/udev/rules.d/下，新建一个51-android.rules文件（sudo  vim  51-android.rules），在这个文件中写上：<br>SUBSYSTEM==”usb”, ATTRS{idVendor}==” 0bb4”, ATTRS{idProduct}==”0c02”,MODE=”0666”<br>保存，再为51-android.rules加上权限（sudo chmod a+x 51-android.rules）.<br>拔掉usb重新插上就可以了，如：<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">xxnan@xxnan-pt:~$ adb devices</div><div class="line">List of devices attached </div><div class="line">0123456789ABCDEF    device</div></pre></td></tr></table></figure></p>
<p>这样就解决了不能识别USB的问题。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/11/git命令大全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/11/git命令大全/" itemprop="url">
                  git命令大全
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-11 13:40:22 / Updated at: 13:40:48" itemprop="dateCreated datePublished" datetime="2018-04-11T13:40:22+08:00">2018-04-11</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">git init                                                  # 初始化本地git仓库（创建新仓库）</div><div class="line">git config --global user.name &quot;xxx&quot;                       # 配置用户名</div><div class="line">git config --global user.email &quot;xxx@xxx.com&quot;              # 配置邮件</div><div class="line">git config --global color.ui true                         # git status等命令自动着色</div><div class="line">git config --global color.status auto</div><div class="line">git config --global color.diff auto</div><div class="line">git config --global color.branch auto</div><div class="line">git config --global color.interactive auto</div><div class="line">git config --global --unset http.proxy                    # remove  proxy configuration on git</div><div class="line">git clone git+ssh://git@192.168.53.168/VT.git             # clone远程仓库</div><div class="line">git status                                                # 查看当前版本状态（是否修改）</div><div class="line">git add xyz                                               # 添加xyz文件至index</div><div class="line">git add .                                                 # 增加当前子目录下所有更改过的文件至index</div><div class="line">git commit -m &apos;xxx&apos;                                       # 提交</div><div class="line">git commit --amend -m &apos;xxx&apos;                               # 合并上一次提交（用于反复修改）</div><div class="line">git commit -am &apos;xxx&apos;                                      # 将add和commit合为一步</div><div class="line">git rm xxx                                                # 删除index中的文件</div><div class="line">git rm -r *                                               # 递归删除</div><div class="line">git log                                                   # 显示提交日志</div><div class="line">git log -1                                                # 显示1行日志 -n为n行</div><div class="line">git log -5</div><div class="line">git log --stat                                            # 显示提交日志及相关变动文件</div><div class="line">git log -p -m</div><div class="line">git show dfb02e6e4f2f7b573337763e5c0013802e392818         # 显示某个提交的详细内容</div><div class="line">git show dfb02                                            # 可只用commitid的前几位</div><div class="line">git show HEAD                                             # 显示HEAD提交日志</div><div class="line">git show HEAD^                                            # 显示HEAD的父（上一个版本）的提交日志 ^^为上两个版本 ^5为上5个版本</div><div class="line">git tag                                                   # 显示已存在的tag</div><div class="line">git tag -a v2.0 -m &apos;xxx&apos;                                  # 增加v2.0的tag</div><div class="line">git show v2.0                                             # 显示v2.0的日志及详细内容</div><div class="line">git log v2.0                                              # 显示v2.0的日志</div><div class="line">git diff                                                  # 显示所有未添加至index的变更</div><div class="line">git diff --cached                                         # 显示所有已添加index但还未commit的变更</div><div class="line">git diff HEAD^                                            # 比较与上一个版本的差异</div><div class="line">git diff HEAD -- ./lib                                    # 比较与HEAD版本lib目录的差异</div><div class="line">git diff origin/master..master                            # 比较远程分支master上有本地分支master上没有的</div><div class="line">git diff origin/master..master --stat                     # 只显示差异的文件，不显示具体内容</div><div class="line">git remote add origin git+ssh://git@192.168.53.168/VT.git # 增加远程定义（用于push/pull/fetch）</div><div class="line">git branch                                                # 显示本地分支</div><div class="line">git branch --contains 50089                               # 显示包含提交50089的分支</div><div class="line">git branch -a                                             # 显示所有分支</div><div class="line">git branch -r                                             # 显示所有原创分支</div><div class="line">git branch --merged                                       # 显示所有已合并到当前分支的分支</div><div class="line">git branch --no-merged                                    # 显示所有未合并到当前分支的分支</div><div class="line">git branch -m master master_copy                          # 本地分支改名</div><div class="line">git checkout -b master_copy                               # 从当前分支创建新分支master_copy并检出</div><div class="line">git checkout -b master master_copy                        # 上面的完整版</div><div class="line">git checkout features/performance                         # 检出已存在的features/performance分支</div><div class="line">git checkout --track hotfixes/BJVEP933                    # 检出远程分支hotfixes/BJVEP933并创建本地跟踪分支</div><div class="line">git checkout v2.0                                         # 检出版本v2.0</div><div class="line">git checkout -b devel origin/develop                      # 从远程分支develop创建新本地分支devel并检出</div><div class="line">git checkout -- README                                    # 检出head版本的README文件（可用于修改错误回退）</div><div class="line">git merge origin/master                                   # 合并远程master分支至当前分支</div><div class="line">git cherry-pick ff44785404a8e                             # 合并提交ff44785404a8e的修改</div><div class="line">git push origin master                                    # 将当前分支push到远程master分支</div><div class="line">git push origin :hotfixes/BJVEP933                        # 删除远程仓库的hotfixes/BJVEP933分支</div><div class="line">git push --tags                                           # 把所有tag推送到远程仓库</div><div class="line">git fetch                                                 # 获取所有远程分支（不更新本地分支，另需merge）</div><div class="line">git fetch --prune                                         # 获取所有原创分支并清除服务器上已删掉的分支</div><div class="line">git pull origin master                                    # 获取远程分支master并merge到当前分支</div><div class="line">git mv README README2                                     # 重命名文件README为README2</div><div class="line">git reset --hard HEAD                                     # 将当前版本重置为HEAD（通常用于merge失败回退）</div><div class="line">git rebase</div><div class="line">git branch -d hotfixes/BJVEP933                           # 删除分支hotfixes/BJVEP933（本分支修改已合并到其他分支）</div><div class="line">git branch -D hotfixes/BJVEP933                           # 强制删除分支hotfixes/BJVEP933</div><div class="line">git ls-files                                              # 列出git index包含的文件</div><div class="line">git show-branch                                           # 图示当前分支历史</div><div class="line">git show-branch --all                                     # 图示所有分支历史</div><div class="line">git whatchanged                                           # 显示提交历史对应的文件修改</div><div class="line">git revert dfb02e6e4f2f7b573337763e5c0013802e392818       # 撤销提交dfb02e6e4f2f7b573337763e5c0013802e392818</div><div class="line">git ls-tree HEAD                                          # 内部命令：显示某个git对象</div><div class="line">git rev-parse v2.0                                        # 内部命令：显示某个ref对于的SHA1 HASH</div><div class="line">git reflog                                                # 显示所有提交，包括孤立节点</div><div class="line">git show HEAD@&#123;5&#125;</div><div class="line">git show master@&#123;yesterday&#125;                               # 显示master分支昨天的状态</div><div class="line">git log --pretty=format:&apos;%h %s&apos; --graph                   # 图示提交日志</div><div class="line">git show HEAD~3</div><div class="line">git show -s --pretty=raw 2be7fcb476</div><div class="line">git stash                                                 # 暂存当前修改，将所有至为HEAD状态</div><div class="line">git stash list                                            # 查看所有暂存</div><div class="line">git stash show -p stash@&#123;0&#125;                               # 参考第一次暂存</div><div class="line">git stash apply stash@&#123;0&#125;                                 # 应用第一次暂存</div><div class="line">git grep &quot;delete from&quot;                                    # 文件中搜索文本“delete from”</div><div class="line">git grep -e &apos;#define&apos; --and -e SORT_DIRENT</div><div class="line">git gc</div><div class="line">git fsck</div></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/11/ANR问题分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/11/ANR问题分析/" itemprop="url">
                  ANR问题分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-11 10:41:59 / Updated at: 10:46:34" itemprop="dateCreated datePublished" datetime="2018-04-11T10:41:59+08:00">2018-04-11</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何去分析ANR"><a href="#如何去分析ANR" class="headerlink" title="如何去分析ANR"></a>如何去分析ANR</h1><p>先看个LOG:<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">04-01 13:12:11.572 I/InputDispatcher( 220): Application is not responding:Window&#123;2b263310com.android.email/com.android.email.activity.SplitScreenActivitypaused=false&#125;.  5009.8ms since event, 5009.5ms since waitstarted</div><div class="line">04-01 13:12:11.572 I/WindowManager( 220): Input event dispatching timedout sending tocom.android.email/com.android.email.activity.SplitScreenActivity</div><div class="line">04-01 13:12:14.123 I/Process(  220): Sending signal. PID: 21404 SIG: 3---发生ANR的时间和生成trace.txt的时间</div><div class="line">04-01 13:12:14.123 I/dalvikvm(21404):threadid=4: reacting to signal 3 </div><div class="line">……</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): ANR in com.android.email(com.android.email/.activity.SplitScreenActivity)</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): Reason:keyDispatchingTimedOut</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): Load: 8.68 / 8.37 / 8.53</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): CPUusage from 4361ms to 699ms ago ----CPU在ANR发生前的使用情况</div><div class="line"></div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   5.5%21404/com.android.email: 1.3% user + 4.1% kernel / faults: 10 minor</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   4.3%220/system_server: 2.7% user + 1.5% kernel / faults: 11 minor 2 major</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   0.9%52/spi_qsd.0: 0% user + 0.9% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   0.5%65/irq/170-cyttsp-: 0% user + 0.5% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   0.5%296/com.android.systemui: 0.5% user + 0% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): 100%TOTAL: 4.8% user + 7.6% kernel + 87% iowait</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): CPUusage from 3697ms to 4223ms later:-- ANR后CPU的使用量</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   25%21404/com.android.email: 25% user + 0% kernel / faults: 191 minor</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):    16% 21603/__eas(par.hakan: 16% user + 0% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):    7.2% 21406/GC: 7.2% user + 0% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):    1.8% 21409/Compiler: 1.8% user + 0% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):   5.5%220/system_server: 0% user + 5.5% kernel / faults: 1 minor</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220):    5.5% 263/InputDispatcher: 0% user + 5.5% kernel</div><div class="line">04-01 13:12:15.872 E/ActivityManager(  220): 32%TOTAL: 28% user + 3.7% kernel</div></pre></td></tr></table></figure></p>
<p>从LOG可以看出ANR的类型，CPU的使用情况，如果CPU使用量接近100%，说明当前设备很忙，有可能是CPU饥饿导致了ANR<br>如果CPU使用量很少，说明主线程被BLOCK了<br>如果IOwait很高，说明ANR有可能是主线程在进行I/O操作造成的<br>除了看LOG，解决ANR还得需要trace.txt文件，<br>如何获取呢？可以用如下命令获取<br><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ chmod 777 /data/anr</div><div class="line">$ rm /data/anr/traces.txt</div><div class="line">$ ps</div><div class="line">$ <span class="built_in">kill</span> -3 PID</div><div class="line">$ adb pull data/anr/traces.txt ./mytraces.txt</div></pre></td></tr></table></figure></p>
<p>从trace.txt文件，看到最多的是如下的信息：<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">-----pid 21404 at 2011-04-01 13:12:14 -----  </div><div class="line">Cmdline: com.android.email</div><div class="line"></div><div class="line">DALVIK THREADS:</div><div class="line">(mutexes: tll=0tsl=0 tscl=0 ghl=0 hwl=0 hwll=0)</div><div class="line">&quot;main&quot; prio=5 tid=1NATIVE</div><div class="line">  | group=&quot;main&quot; sCount=1 dsCount=0obj=0x2aad2248 self=0xcf70</div><div class="line">  | sysTid=21404 nice=0 sched=0/0cgrp=[fopen-error:2] handle=1876218976</div><div class="line">  at android.os.MessageQueue.nativePollOnce(Native Method)</div><div class="line">  at android.os.MessageQueue.next(MessageQueue.java:119)</div><div class="line">  at android.os.Looper.loop(Looper.java:110)</div><div class="line">  at android.app.ActivityThread.main(ActivityThread.java:3688)</div><div class="line">  at java.lang.reflect.Method.invokeNative(Native Method)</div><div class="line">  at java.lang.reflect.Method.invoke(Method.java:507)</div><div class="line">  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:866)</div><div class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:624)</div><div class="line">  at dalvik.system.NativeStart.main(Native Method)</div></pre></td></tr></table></figure></p>
<p>说明主线程在等待下条消息进入消息队列</p>
<h2 id="Thread状态"><a href="#Thread状态" class="headerlink" title="Thread状态"></a>Thread状态</h2><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ThreadState (defined at “dalvik/vm/thread.h “)</div><div class="line">THREAD_UNDEFINED = -1, /* makes enum compatible with int32_t */</div><div class="line">THREAD_ZOMBIE = 0, /* TERMINATED */</div><div class="line">THREAD_RUNNING = 1, /* RUNNABLE or running now */</div><div class="line">THREAD_TIMED_WAIT = 2, /* TIMED_WAITING in Object.wait() */</div><div class="line">THREAD_MONITOR = 3, /* BLOCKED on a monitor */</div><div class="line">THREAD_WAIT = 4, /* WAITING in Object.wait() */</div><div class="line">THREAD_INITIALIZING= 5, /* allocated, not yet running */</div><div class="line">THREAD_STARTING = 6, /* started, not yet on thread list */</div><div class="line">THREAD_NATIVE = 7, /* off in a JNI native method */</div><div class="line">THREAD_VMWAIT = 8, /* waiting on a VM resource */</div><div class="line">THREAD_SUSPENDED = 9, /* suspended, usually by GC or debugger */</div></pre></td></tr></table></figure>
<h2 id="如何调查并解决ANR"><a href="#如何调查并解决ANR" class="headerlink" title="如何调查并解决ANR"></a>如何调查并解决ANR</h2><blockquote>
<p>1 : 首先分析log<br>2 : 从trace.txt文件查看调用stack.<br>3 : 看代码<br>4 : 仔细查看ANR的成因（iowait?block?memoryleak?）</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/09/mtklog分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/09/mtklog分析/" itemprop="url">
                  mtklog分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-09 13:10:12 / Updated at: 13:38:12" itemprop="dateCreated datePublished" datetime="2018-04-09T13:10:12+08:00">2018-04-09</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.cnblogs.com/xiyuan2016/p/6740521.html" target="_blank" rel="external">https://www.cnblogs.com/xiyuan2016/p/6740521.html</a></p>
<p><a href="http://www.voidcn.com/article/p-btyoxkos-bpn.html" target="_blank" rel="external">http://www.voidcn.com/article/p-btyoxkos-bpn.html</a></p>
<h3 id="Mtklog-结构"><a href="#Mtklog-结构" class="headerlink" title="Mtklog 结构"></a>Mtklog 结构</h3><p>mtklog分析:  </p>
<pre><code>1. mdlog1                           // modem 相关底层的log  
    1.1 MDLog1_2010_0101_000152     // 每次打开mtklog都会新建一个文件夹  
    1.2 MDLog1_2015_0101_000042  

2. mobilelog                        // android log 和 kernel log  
    2.1 APLog_2010_0101_000147  
    2.1 APLog_2015_0101_000037        
        atf_log                     // 所有_log都是进入安卓之后的  
        atf_log.boot                // 所有.boot都是启动到进入安卓之前的log  
        bootprof                    // 启动的简要信息 - 可以分析启动时间 - 启动模式(普通or看门狗or按键())  
        cmdline                     // lk传给kernel的参数(包括lcm等) - 可以自己加  
        crash_log                   // 崩溃log  
        crash_log.boot  
        events_log                  // 事件log，主要输出记录各个activity周期及事件  
        events_log.boot：  
        kernel_log                  // 内核log，常用  
        kernel_log.boot  
        last_kmsg                   // 上一次关机前的log - 可以分析重启原因  
        main_log                    // hal层的log打印在这里  
        main_log.boot  
        mblog_history               // 本目录下所有log的大小等信息  
        ProjectConfig.mk            // 工程配置  
        properties                  // 属性  
        radio_log                   // 输出通话，网络状态变化  
        radio_log.boot  
        sys_log                     // jni、framework层log，Exception定位点  
        sys_log.boot  

3. netlog                           //网络log  
    3.1 NTLog_2010_0101_000147  
        NTLog_2015_0101_000037  
        tcpdump_NTLog_2015_0101_000037_start.cap.tmp  

4. running_file_tree.txt            //
</code></pre><h3 id="ZZ-INTERNAL相关信息及解释"><a href="#ZZ-INTERNAL相关信息及解释" class="headerlink" title="ZZ_INTERNAL相关信息及解释"></a>ZZ_INTERNAL相关信息及解释</h3><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ANR,2173,-1361051648,99,/data/core/,1,system_app_anr,android.process.media,Tue Jul  4 18:51:03 HKT 2017,1</div><div class="line"></div><div class="line">第一列：exception class，有KE/NE/JE/EE等</div><div class="line">第二列：pid</div><div class="line">第三列：tid</div><div class="line">第四列：固定是99</div><div class="line">第五列：固定是/data/core</div><div class="line">第六列：exception level，0: fatal, 1: exception, 2: warning, 3: reminding</div><div class="line">第七列：exception type info string (如果是NE，则这个栏位是signal名称，比如：SIGSEGV，KE则为空，SWT则为:system_server_watchdog)</div><div class="line">第八列：module name or process name</div><div class="line">第九列：UTC time</div><div class="line">第十列：固定是1</div></pre></td></tr></table></figure>
<h3 id="trace部分信息解析"><a href="#trace部分信息解析" class="headerlink" title="trace部分信息解析"></a>trace部分信息解析</h3><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">----- pid 2173 at 2017-07-04 11:51:32 -----</div><div class="line">Cmd line: android.process.media</div><div class="line">&quot;main&quot; prio=5 tid=1 Native</div><div class="line">&quot;Binder:2173_1&quot; prio=5 tid=9 Blocked</div><div class="line">  | group=&quot;main&quot; sCount=1 dsCount=0 obj=0x22c05430 self=0xa1fcab00</div><div class="line">  | sysTid=2186 nice=10 cgrp=bg_non_interactive sched=0/0 handle=0xa497a920</div><div class="line">  | state=S schedstat=( 26942858 122825452 281 ) utm=0 stm=2 core=0 HZ=100</div><div class="line">  | stack=0xa487e000-0xa4880000 stackSize=1014KB</div><div class="line">  | held mutexes=</div><div class="line">  at com.android.providers.media.MediaProvider.getParent(MediaProvider.java:4118)</div><div class="line">  - waiting to lock &lt;0x06de4cd2&gt; (a java.util.HashMap) held by thread 13</div><div class="line">  at com.android.providers.media.MediaProvider.insertFile(MediaProvider.java:4395)</div><div class="line">  at com.android.providers.media.MediaProvider.insertInternal(MediaProvider.java:4662)</div><div class="line">  at com.android.providers.media.MediaProvider.insert(MediaProvider.java:4015)</div><div class="line">  at android.content.ContentProvider$Transport.insert(ContentProvider.java:272)</div><div class="line">  at android.content.ContentProviderNative.onTransact(ContentProviderNative.java:163)</div><div class="line">  at android.os.Binder.execTransact(Binder.java:570)</div></pre></td></tr></table></figure>
<p>1)pid 2173 at 2017-07-04 11:51:32<br>  ANR发生的进程的ID，时间点</p>
<p>2)Cmd line: android.process.media<br>  ANR发生的进程的名称</p>
<p>3)”main” prio=5 tid=1 Native<br>  说明线程名，线程的优先级，线程锁ID和线程状态.<br>  线程名称是启动线程的时候手动指明的，这里的main标示是主线程，<br>  是Android自动设定的一个线程名称，如果是自己手动创建的线程，<br>  一般会被命名成“Thread-xx”的格式，启动xx是线程ID，他只增不减<br>  不会被复用;注意这启动的tid不是线程的id，他是一个在Java虚拟机<br>  中用来实现线程锁的变量，随着线程的增减，这个变量的值是可能被<br>  复用的；</p>
<p>4)group=”main” sCount=1 dsCount=0 obj=0x22c05430 self=0xa1fcab00<br>  group是线程组名称。<br>  sCount是此线程被挂起的次数，<br>  dsCount是线程被调试器挂起的次数。<br>  当一个进程被调试后，sCount会重置为，调试完毕后sCount会根据是否<br>  被正常挂起增长，但是dsCount不会被重置为0，所以dsCount也可以用来<br>  判断这个线程是否被调试过，obj表示这个线程的Java对象地址，self表<br>  示这个线程本身的地址。</p>
<p>5)此后是线程的调度信息<br>| sysTid=2186 nice=10 cgrp=bg_non_interactive sched=0/0 handle=0xa497a920<br>  sysTid是Linux下的内核线程ID，<br>  nice是线程调度的优先级.<br>  sched分别标志了线程的调度策略和优先级，<br>  cgrp是调度属组，<br>  handle是线程的处理函数地址。</p>
<p>6)线程当前上下文信息<br> | state=S schedstat=( 26942858 122825452 281 ) utm=0 stm=2 core=0 HZ=100<br>  state是调度状态;<br>  schedstat从 /proc/[pid]/task/[tid]/schedstat读出<br>  三个值分别表示线程在cpu上执行的时间、线程的等待时间和线程执行的时间片长度;<br>  有的android内核版本不支持这项信息，得到的三个值都是0；utm是线程用户态下使<br>  用的时间值(单位是jiffies);stm是内核态下的调度时间值;core是最后执行这个线程<br>  cpu核的序号</p>
<p>7)最后就是这个线程的调度栈信息。<br>  一般可以通过以下几个简单的方法来判断<br>  <em>trace文件顶部的线程一般是ANR的元凶。
  </em>这是一个简单的方法，大部分情况下都适用，可以通过这个方法来快速判断是否是自己<br>   的应用造成了本次的ANR，但是并不是trace文件包含的应用就一定是造成ANR的帮凶，应<br>   用出现在trace文件中，只能说明出现ANR的时候这个应用进程还活着，trace文件的顶部<br>   则是触发ANR的应用信息，因此如果你的应用出现在trace文件的顶部，那么很有可能是<br>   因为你的应用造成了ANR,否则是你的应用造成ANR的可能性不大，还需要进一步分析。</p>
<p>8)如果定位不到时间点，可以看CPU<br>  (sys_log)07-04 18:51:03.209156  1044  1068 E ANRManager: 3.4% TOTAL: 0.5% user  + 2.6% kernel + 0.2% irq<br>   从CPU使用率可以看出:<br>   <em>如果使用量很高，说明当前设备很忙(内存不足，循环处理)
   </em>如果CPU使用量很少，说明主线程被BLOCK了<br>   *如果IOwait很高，说明ANR有可能是主线程在进行I/O操作造成的(数据库、文件操作、<br>    网络操作等)      </p>
<p>9)等待锁引起的ANR<br>  找到WallpaperManager对应代码，再结合main log等其他信息，看tid=27的thread在忙<br>  什么。</p>
<p>10)SWT重启问题分析<br>  SWT是指Android Watchdog Timeout，应用层看门狗超时，通常我们说的WDT是HWT，硬件<br>  看门狗超时。<br>  1.Watchdog的目的是监控系统几个比较主要的service，比如NetworkManagementService，<br>  PowerManagerService，ActivityManagerService等。这些Service在启动时通过调用<br>  Watchdog。getInstance().addMonitor(this);加入到Watchdog的监控列表中，如果超过<br>  一定时间没有反应，认为系统出错，会强制启动Android。<br>  2.Watchdog原理：/framework/base/services/java/com/android/server/Watchdog.java<br>  3.具体分析方法<br>    <em>首先从enventlog中以watchdog为关键字搜索，记录下这个时刻<br>      17:25:23.645459 950 1285 I watchdog:surfaceflinger hang.
    </em>然后分析所有Service Object的monitor()为何在这个时刻之前1分钟没有做完，<br>    <em>后面具体分析方法和ANR一样
    </em>ANR是某个AP的主线程在一段时间内没有完成某件事情，<br>    *Android Watchdog 是SystemServer进程的ServerThread 线程在一段时间内没有做完<br>     某件事情。                </p>
<h3 id="radio-log分析网络状况"><a href="#radio-log分析网络状况" class="headerlink" title="radio_log分析网络状况"></a>radio_log分析网络状况</h3><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">06-30 10:38:06.572525 938 976 I AT : AT&lt; +ECSQ: 22,54,1,1,1,-36,-346,7,39 (RIL_URC_READER, tid:0)</div><div class="line">06-30 10:38:06.572737 938 976 I RILC : RIL_SOCKET_1 UNSOLICITED: UNSOL_SIGNAL_STRENGTH length:72</div><div class="line">06-30 10:38:06.573125 938 998 I RIL : [GSM MAL] URC send success, rid 0, ret 0:      #F5F6FA</div><div class="line">06-30 10:38:06.573125 938 998 I RIL : +ECSQ: 22,54,1,1,1,-36,-346,7,39</div><div class="line">06-30 10:38:06.574384 1028 1067 D RilMalClient: UNSOL_TO_MAL: remap to unsol resp(1009)</div><div class="line">06-30 10:38:06.575465 1028 1067 D RpRilClientController: leave blocking write</div><div class="line">06-30 10:38:06.575605 1028 1067 D RpRilClientController: leave blocking write</div><div class="line">06-30 10:38:06.576133 1425 1425 D SST : [GsmSST0] handle EVENT_SIGNAL_STRENGTH_UPDATE</div><div class="line">06-30 10:38:06.576410 1425 1425 W SignalStrength: Signal before validate=SignalStrength: 0 54 -1 -1 -1 -1 -1 99 86 9 97 2147483647 2147483647 gsm|lte 2147483647 2147483647 2147483647</div><div class="line">06-30 10:38:06.576526 1425 1425 W SignalStrength: Signal after validate=SignalStrength: 0 54 -120 -160 -120 -1 -1 99 -86 -9 97 2147483647 2147483647 gsm|lte 2147483647 2147483647 2147483647</div><div class="line">06-30 10:38:06.577794 1010 1367 D TelephonyRegistry: notifySignalStrengthForPhoneId: callback.onSsS r=&#123;callingPackage=android binder=android.telephony.PhoneStateListener$IPhoneStateListenerStub@d4b4edc callback=android.telephony.PhoneStateListener$IPhoneStateListenerStub@d4b4edc onSubscriptionsChangedListenererCallback=null callerUserId=0 subId=2147483647 phoneId=-1 events=1c1 canReadPhoneState=true&#125; subId=3 phoneId=0 ss=SignalStrength: 0 54 -120 -160 -120 -1 -1 99 -86 -9 97 2147483647 2147483647 gsm|lte 2147483647 2147483647 2147483647</div><div class="line">06-30 10:38:06.578163 1010 1367 D TelephonyRegistry: notifySignalStrengthForPhoneId: callback.onSsS r=&#123;callingPackage=com.android.systemui binder=android.os.BinderProxy@d2e4c9 callback=com.android.internal.telephony.IPhoneStateListener$Stub$Proxy@7f6d7ce onSubscriptionsChangedListenererCallback=null callerUserId=0 subId=3 phoneId=0 events=101e1 canReadPhoneState=true&#125; subId=3 phoneId=0 ss=SignalStrength: 0 54 -120 -160 -120 -1 -1 99 -86 -9 97 2147483647 2147483647 gsm|lte 2147483647 2147483647 2147483647</div><div class="line">06-30 10:38:06.578577 1010 1367 I use-Rlog/RLOG-GSM: getLTELevel - rsrp:-86 snr:97 rsrpIconLevel:3 snrIconLevel:3</div><div class="line">06-30 10:38:06.578693 1010 1367 W SignalStrength: getLevel=3</div><div class="line">06-30 10:38:06.579533 1305 1531 I use-Rlog/RLOG-GSM: getLTELevel - rsrp:-86 snr:97 rsrpIconLevel:3 snrIconLevel:3</div><div class="line">06-30 10:38:06.582788 1305 1531 W SignalStrength: getLevel=3</div><div class="line">06-30 10:38:06.588566 1305 1531 I use-Rlog/RLOG-GSM: getLTELevel - rsrp:-86 snr:97 rsrpIconLevel:3 snrIconLevel:3</div><div class="line">06-30 10:38:06.589489 1305 1531 W SignalStrength: getLevel=3</div></pre></td></tr></table></figure>
<figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">3G modem:</div><div class="line">+ECSQ: &lt;asu&gt;, &lt;ber&gt;, &lt;rssi&gt; （2G网络）</div><div class="line">+ECSQ: &lt;asu&gt;, &lt;ber&gt;, &lt;rssi&gt;, &lt;rscp&gt;, &lt;ec/no&gt; （3G网络）</div><div class="line">4G modem:</div><div class="line">+ECSQ: &lt;asu&gt;, &lt;ber&gt;, &lt;rssi&gt;, &lt;rscp&gt;,1,1,1,&lt;act&gt; （2G网络）</div><div class="line">+ECSQ: &lt;asu&gt;, &lt;ber&gt;, &lt;rssi&gt;, &lt;rscp&gt;, &lt;ec/no&gt;,1,1, &lt;act&gt; （3G网络）</div><div class="line">+ECSQ: &lt;rsrq&gt;, &lt;rsrp&gt;,1,1,1,&lt;rsrq_qdbm &gt;,&lt;rsrp_qdbm&gt; &lt;act&gt; （4G网络）</div><div class="line"></div><div class="line">看+ECSQ 命令带的值:</div><div class="line">*如果第六第七位不是255 or 1 则当前在LTE状态，</div><div class="line">*如果第四第五位不是255 or 1 则当前在3G mode。</div><div class="line">*2G的话不是很清楚怎么看radio log,一般是在modem log里确认的。</div><div class="line">+ECSQ:&lt;sig1&gt;,&lt;sig2&gt;,&lt;rssi_in_qdbm&gt;,&lt;rscp_in_qdbm&gt;,&lt;ecn0_in_qdbm&gt;,&lt;rsrq_in_qdbm&gt;,&lt;rsrp_in_qdbm&gt;,&lt;Act&gt;</div><div class="line">从radio log看，手机应该在</div><div class="line">4G mode时, 如果 SNR&lt;0 (RSRQ&lt;-60dbm)，则信号很差。</div><div class="line">3G mode时, EcN0&lt;-15 (RSCP&lt;-115dbm)时信号很差</div><div class="line">2G mode时, 2G：rssi&lt; -95dbm 、 rscq &gt; 4 (0~7 ,0最好，7最差)</div></pre></td></tr></table></figure>
<h3 id="通话问题分析"><a href="#通话问题分析" class="headerlink" title="通话问题分析"></a>通话问题分析</h3><p>很多场测神马的，都会报出很多通话相关的bug，有些是通话无声，有些事通话质量不好，等等。遇到这种问题原来都是直接提给MTK的，后面发现很多都是网络质量问题，遂跟MTK讨了方法。在radiolog中搜索 +ECSQ:<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">06-30 10:38:06.572525 938 976 I AT : AT&lt; +ECSQ: 22,54,1,1,1,-36,-346,7,39 (RIL_URC_READER, tid:0)</div></pre></td></tr></table></figure></p>
<p>看+ECSQ 命令带的值，<br>如果第六第七位不是255 or 1 则当前在LTE状态，<br>如果第四第五位不是255or1则当前在3G mode。<br>2G的话不是很清楚怎么看radio log,一般是在modem log里确认的。<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ECSQ:&lt;sig1&gt;,&lt;sig2&gt;,&lt;rssi_in_qdbm&gt;,&lt;rscp_in_qdbm&gt;,&lt;ecn0_in_qdbm&gt;,&lt;rsrq_in_qdbm&gt;,&lt;rsrp_in_qdbm&gt; ,&lt;Act&gt;</div></pre></td></tr></table></figure></p>
<p>判断信号质量:<br>手机应该在4G下。如果 SNR &lt; 0 (RSRQ &lt;-60)，则信号很差。<br>3G mode时， EcN0&lt;-15 (RSCP&lt;-115)时信号很差。<br>2G mode时， rssi&lt; -95dbm 、 rscq &gt; 4 (0~7 ,0最好，7最差)</p>
<h3 id="ANR-问题分析流程"><a href="#ANR-问题分析流程" class="headerlink" title="ANR 问题分析流程"></a>ANR 问题分析流程</h3><h4 id="1-定位问题点"><a href="#1-定位问题点" class="headerlink" title="1.定位问题点"></a>1.定位问题点</h4><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">a) 使用mobile log</div><div class="line">*events_log中搜索am_anr</div><div class="line">*main_log 或 Sys_log 中搜索ANR in</div><div class="line">*traces.txt中查找相应的PID或者进程名</div><div class="line"></div><div class="line">b) 使用anr db文件 </div><div class="line">*使用gat工具打开db文件</div><div class="line">*查看ZZ_INTERNAL文件 找到pid或者进程名</div><div class="line">*在SWT_JBT_TRACES查找pid</div></pre></td></tr></table></figure>
<h4 id="2-在mainlog中查看cpu"><a href="#2-在mainlog中查看cpu" class="headerlink" title="2.在mainlog中查看cpu"></a>2.在mainlog中查看cpu</h4><p>一般在trace就能看到问题点，如果还是定位不到，就需要在mainlog中搜索TOTAL：<br>查看CPU使用率  进而确认问题</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/09/The-application-may-be-doing-too-much-work-on-its-main-thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/09/The-application-may-be-doing-too-much-work-on-its-main-thread/" itemprop="url">
                  The application may be doing too much work on its main thread
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-09 10:34:00 / Updated at: 12:56:05" itemprop="dateCreated datePublished" datetime="2018-04-09T10:34:00+08:00">2018-04-09</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在 mtklog 中搜索 grep “Skipped.*frames” ./ -ri ,搜索结果如下:<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">./main_log:04-02 12:59:51.789230 6259 6259 I Choreographer: Skipped 67 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 12:59:54.948920 6259 6259 I Choreographer: Skipped 114 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 12:59:55.683659 6259 6259 I Choreographer: Skipped 41 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 12:59:58.288454 6259 6259 I Choreographer: Skipped 152 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 12:59:59.693032 6259 6259 I Choreographer: Skipped 71 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:02.947048 6259 6259 I Choreographer: Skipped 71 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:03.461233 6259 6259 I Choreographer: Skipped 30 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:04.653194 6259 6259 I Choreographer: Skipped 31 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:07.490548 6259 6259 I Choreographer: Skipped 58 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:08.920317 11468 11468 I Choreographer: Skipped 53 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:35.015765 6259 6259 I Choreographer: Skipped 49 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:36.722107 894 894 I Choreographer: Skipped 51 frames! The application may be doing too much work on its main thread.</div><div class="line">./main_log:04-02 13:00:38.924398 894 894 I Choreographer: Skipped 32 frames! The application may be doing too much work on its main thread.</div></pre></td></tr></table></figure></p>
<p>从log中看出有很多地方在掉帧,在网上查到出现 The application may be doing too much work on its main thread 的原因如下:<br>意思是：主线程中有耗时操作，主线程受不了了。原因是我在重写callback的handleMessage方法时，模拟了延时操作。实际在开发中，这种情况是万万不可的，解决办法是实现android的两大原则：</p>
<blockquote>
<ol>
<li>不要！不要在主线程（UI线程）中执行耗时操作，如网络请求，数据库操作等。应另开线程操作，实现方式有1) 自开线程new Thread；2) runOnUIThread; 3) post方法以及4) 异步AsyncTask</li>
<li>一定！一定要在主线程（UI线程）中修改控件的状态。否则会报：Only the original thread that created a view hierarchy can touch its views</li>
</ol>
</blockquote>
<p>英文原版解释:<br>Anyone who begins developing android application sees this message on logcat “Choreographer(abc): Skipped xx frames! The application may be doing too much work on its main thread.” So what does it actually means, why should you be concerned and how to solve it.</p>
<p>What this means is that your code is taking long to process and frames are being skipped because of it, It maybe because of some heavy processing that you are doing at the heart of your application or DB access or any other thing which causes the thread to stop for a while. Here is a more detailed explanation –</p>
<p>Choreographer lets apps to connect themselves to the vsync, and properly time things to improve performance.</p>
<p>Android view animations internally uses Choreographer for the same purpose: to properly time the animations and possibly improve performance.</p>
<p>Since Choreographer is told about every vsync events, I can tell if one of the Runnables passed along by the Choreographer.post* apis doesnt finish in one frame’s time, causing frames to be skipped.</p>
<p>In my understanding Choreographer can only detect the frame skipping. It has no way of telling why this happens.</p>
<p>The message “The application may be doing too much work on its main thread.” could be misleading.</p>
<p>source :  <a href="http://stackoverflow.com/questions/11266535/meaning-of-choreographer-messages-in-logcat" target="_blank" rel="external">http://stackoverflow.com/questions/11266535/meaning-of-choreographer-messages-in-logcat</a></p>
<p>Why you should be concerned<br>When this message pops up on android emulator and the number of frames skipped are fairly small (&lt;100) then you can take a safe bet of the emulator being slow – which happens almost all the times. But if the number of frames skipped and large and in the order of 300+ then there can be some serious trouble with your code. Android devices come in a vast array of hardware unlike ios and windows devices. The RAM and CPU varies and if you want a reasonable performance and user experience on all the devices then you need to fix this thing. When frames are skipped the UI is slow and laggy, which is not a desirable user experience.</p>
<p>How to fix it<br>Fixing this requires identifying nodes where there is or possibly can happen long duration of processing. The best way is to do all the processing no matter how small or big in a thread separate from main UI thread. So be it accessing data form SQLite Database or doing some hardcore maths or simply sorting an array – Do it in a different thread</p>
<p>Now there is a catch here, You will create a new Thread for doing these operations and when you run your application, it will crash saying “Only the original thread that created a view hierarchy can touch its views“. You need to know this fact that UI in android can be changed by the main thread or the UI thread only. Any other thread which attempts to do so, fails and crashes with this error. What you need to do is create a new Runnable inside runOnUiThread and inside this runnable you should do all the operations involving the UI. Find an example here.</p>
<p>So we have Thread and Runnable for processing data out of main Thread, what else? There is AsyncTask in android which enables doing long time processes on the UI thread. This is the most useful when you applications are data driven or web api driven or use complex UI’s like those build using Canvas. The power of AsyncTask is that is allows doing things in background and once you are done doing the processing, you can simply do the required actions on UI without causing any lagging effect. This is possible because the AsyncTask derives itself from Activity’s UI thread – all the operations you do on UI via AsyncTask are done is a different thread from the main UI thread, No hindrance to user interaction.</p>
<p>So this is what you need to know for making smooth android applications and as far I know every beginner gets this message on his console.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/09/Channel-is-unrecoverably-broken-and-will-be-disposed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/09/Channel-is-unrecoverably-broken-and-will-be-disposed/" itemprop="url">
                  Channel is unrecoverably broken and will be disposed
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-04-09 10:24:45 / Updated at: 10:32:40" itemprop="dateCreated datePublished" datetime="2018-04-09T10:24:45+08:00">2018-04-09</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Channel is unrecoverably broken and will be disposed</p>
<h1 id="第一篇"><a href="#第一篇" class="headerlink" title="第一篇"></a>第一篇</h1><p>今天遇到了一个头疼的问题，就是本来程序昨天都是好好的，但是今天在该页面退出的时候就报通道破碎错误了，直接闪屏，头大，上网搜了一下资料，再结合昨晚写的代码，预估可能是网络请求的问题，搞了半天解决了，记录一下。<br>报错记录</p>
<figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">05-25 10:52:21.125 491-528/system_process E/InputDispatcher: channel &apos;4a8b59f4 activity.MainActivity (server)&apos; ~ Channel is unrecoverably broken and will be disposed!</div><div class="line">05-25 10:52:21.125 491-528/system_process E/InputDispatcher: channel &apos;4a9790c4 activity.ShoppingCartActivity (server)&apos; ~ Channel is unrecoverably broken and will be disposed!</div></pre></td></tr></table></figure>
<h3 id="出错位置"><a href="#出错位置" class="headerlink" title="出错位置"></a>出错位置</h3><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">        <span class="keyword">switch</span> (msg.what)&#123;</div><div class="line">            <span class="keyword">case</span> KEY:</div><div class="line">                <span class="keyword">if</span> (ispay) &#123;</div><div class="line">                    Map&lt;String, String&gt; param = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">                    String orderId = SharePreferenceUtils.readString(PayActivity.<span class="keyword">this</span>, <span class="string">"user"</span>, <span class="string">"orderId"</span>);</div><div class="line">                    param.put(<span class="string">"orderId"</span>,orderId);</div><div class="line">                    PayActivity.<span class="keyword">this</span>.post(Api.PayResult,param, PayResultBean.class);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>这行网络请求（这是我写的一个xutils封装类里的post请求方法）出了问题：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PayActivity.<span class="keyword">this</span>.post(Api.PayResult,param, PayResultBean.class);</div></pre></td></tr></table></figure></p>
<p>具体原因就是因为页面在退出的时候，该行代码依然在执行，所以报错，紧急之下也没做其他的处理，只是写了一个标志位，在页面退出的时候设置为false，这个方法其实不太好，暂时先这样，后期改进。<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    ispay = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="解决问题思路"><a href="#解决问题思路" class="headerlink" title="解决问题思路"></a>解决问题思路</h3><p>改正后，就不在报那个错了，从报这个错误消息的情况来看，如果程序报Channel is unrecoverably broken and will be disposed!时，首先可以考虑是不是代码中某个有数据输入或是有数据输出的地方，写错了代码。</p>
<h3 id="稍做补充"><a href="#稍做补充" class="headerlink" title="稍做补充"></a>稍做补充</h3><p>下午又遇到这个问题了，看了一下，原来是后台接口数据做了改动，我重新生成bean对象的时候，有个为long类型的数据变成了String类型我也没注意到，改正过来就好了。写代码细心很重要，引以为戒，下不为例。</p>
<h1 id="第二篇"><a href="#第二篇" class="headerlink" title="第二篇"></a>第二篇</h1><p>刚才测试代码时，报了如下的错误消息：<br><figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">04-23 14:09:18.608: E/InputDispatcher(99): channel &apos;405fd468 cn.jbit.NewsManager/cn.jbit.NewsManager.NewsManagerActivity (server)&apos; ~Channel is unrecoverably broken and will be disposed!</div></pre></td></tr></table></figure></p>
<p>由于前面写代码时，遇到过类似的错误消息，这次遇到就得心应手了，从错误的消息来看，可以确定是代码中某个有数据输入的地方写错了，于是，找到我刚才的代码中，有数据输入的地方，详见下边：</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***</span></div><div class="line"><span class="comment">*   利用GET方式 提交 数据</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> strtitle</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> strauthor</span></div><div class="line"><span class="comment">* <span class="doctag">@param</span> string</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span></span></div><div class="line"><span class="comment">* <span class="doctag">@throws</span> Exception </span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">saveByGET</span><span class="params">(String strtitle, String strauthor)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    StringBuffer buffer  =<span class="keyword">new</span> StringBuffer();  </div><div class="line">    buffer.append(<span class="string">"?title="</span>).append(URLEncoder.encode(strtitle, <span class="string">"UTF-8"</span>)+<span class="string">"&amp;author="</span>).append(URLEncoder.encode(strauthor, <span class="string">"UTF-8"</span>));</div><div class="line">    URL url  =<span class="keyword">new</span> URL(<span class="string">"http://192.168.137.1/JspUnit2/NewsAddServlet"</span>+buffer.toString());</div><div class="line">    HttpURLConnection conn =(HttpURLConnection)url.openConnection();</div><div class="line">    conn.setConnectTimeout(<span class="number">5000</span>);</div><div class="line">    conn.setRequestMethod(<span class="string">"GET"</span>);</div><div class="line">    <span class="keyword">if</span>(conn.getResponseCode()==<span class="number">200</span>)&#123;</div><div class="line">    	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一看，上面的代码中，红色部分中少了:8080,不知道，自己当时是怎么了，把这个给写漏了，正确的代码应该是：<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">URL url  = <span class="keyword">new</span> URL(<span class="string">"http://192.168.137.1:8080/JspUnit2/NewsAddServlet"</span> + buffer.toString());</div></pre></td></tr></table></figure></p>
<p>改正后，就不在报那个错了，从这几次，报这个错误消息的情况来看，如果程序报Channel is unrecoverably broken and will be disposed!时，首先可以考虑是不是代码中某个有数据输入或是有数据输出的地方，写错了代码。</p>
<p>以上是两篇 Channel is unrecoverably broken and will be disposed 的解决思路,仅供参考!</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/26/在framework下添加字体和使用方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/在framework下添加字体和使用方法/" itemprop="url">
                  在framework下添加字体和使用方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-03-26 14:58:38 / Updated at: 15:02:38" itemprop="dateCreated datePublished" datetime="2018-03-26T14:58:38+08:00">2018-03-26</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.将需要添加的ttf字体文件放在 frameworks/base/data/fonts/ 目录</p>
<p>A:frameworks/base/data/fonts/clock_thin.ttf</p>
<p>2.修改 frameworks/base/data/fonts/Android.mk 文件,将字体文件编译到 system/fonts/ 目录中</p>
<p>M:frameworks/base/data/fonts/Android.mk<br>font_src_files := \<br>    AndroidClock.ttf \<br>    clock_thin.ttf</p>
<p>3.修改 frameworks/base/data/fonts/fonts.mk 文件</p>
<p>M:frameworks/base/data/fonts/fonts.mk<br>PRODUCT_PACKAGES := \<br>    DroidSansMono.ttf \<br>    AndroidClock.ttf \<br>    clock_thin.ttf \<br>    fonts.xml</p>
<p>4.在 fonts.xml 文件中定义字体对应的名称</p>
<p>M:frameworks/base/data/fonts/fonts.xml<br><figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">family</span> <span class="attr">name</span>=<span class="string">"clock-font"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">font</span> <span class="attr">weight</span>=<span class="string">"400"</span> <span class="attr">style</span>=<span class="string">"normal"</span>&gt;</span>clock_thin.ttf<span class="tag">&lt;/<span class="name">font</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">family</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>5.使用新添加的字体</p>
<p>方法1:<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">TextView textView = <span class="keyword">new</span> TextView(mContext);</div><div class="line">textView.setTypeface(android.graphics.Typeface.createFromFile(<span class="string">"/system/fonts/clock_thin.ttf"</span>));</div></pre></td></tr></table></figure></p>
<p>方法2:<br><figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:fontFamily</span>=<span class="string">"clock-font"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>6.在项目中的具体使用实例</p>
<p>M:alps/frameworks/base/core/java/android/widget/RemoteViews.java<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteViews</span> <span class="keyword">implements</span> <span class="title">Parcelable</span>, <span class="title">Filter</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TextViewSizeAction</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(View root, ViewGroup rootParent, OnClickHandler handler)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> TextView target = root.findViewById(viewId);</div><div class="line">            <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">            <span class="comment">//通过特殊约定的参数(如77,0)来特殊设置TextView的字体</span></div><div class="line">            <span class="keyword">if</span>(units == -<span class="number">77</span> &amp;&amp; size == <span class="number">0f</span>)&#123;</div><div class="line">                target.setTypeface(android.graphics.Typeface.createFromFile(<span class="string">"/system/fonts/clock_thin.ttf"</span>));</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                target.setTextSize(units, size);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>M:alps/vendor/mediatek/proprietary/packages/apps/DeskClock/src/com/android/alarmclock/DigitalAppWidgetProvider.java<br><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DigitalAppWidgetProvider</span> <span class="keyword">extends</span> <span class="title">AppWidgetProvider</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RemoteViews <span class="title">relayoutWidget</span><span class="params">(Context context, AppWidgetManager wm, <span class="keyword">int</span> widgetId, Bundle options, <span class="keyword">boolean</span> portrait)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> String packageName = context.getPackageName();</div><div class="line">        <span class="keyword">final</span> RemoteViews rv = <span class="keyword">new</span> RemoteViews(packageName, R.layout.digital_widget);</div><div class="line">        <span class="comment">//通过特殊约定的参数(如77,0)来特殊设置TextView的字体,这里调用setTextViewTextSize方法就会调用RemoteViews的内部类TextViewSizeAction的apply方法</span></div><div class="line">        rv.setTextViewTextSize(R.id.clock, -<span class="number">77</span>, <span class="number">0f</span>);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/26/android-am-pm-wm命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王大可">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王大可的茅草房">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/android-am-pm-wm命令/" itemprop="url">
                  android am pm wm命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2018-03-26 13:25:19 / Updated at: 14:28:06" itemprop="dateCreated datePublished" datetime="2018-03-26T13:25:19+08:00">2018-03-26</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="am命令"><a href="#am命令" class="headerlink" title="am命令"></a>am命令</h1><p>am全称activity manager，你能使用am去模拟各种系统的行为，例如去启动一个activity，强制停止进程，发送广播进程，修改设备屏幕属性等等。当你在adb shell命令下执行am命令:am <command><br>你也可以在adb shell前执行am命令:<br>adb shell am start -a android.intent.action.VIEW<br>关于一些am命令的介绍:</p>
<p>start [options] <intent> :启动activity通过指定的intent参数。</intent></p>
<p>adb shell am start [options] <intent></intent></p>
<p>作用:启动一个activity</p>
<p>举例:adb shell am start -a com.lt.test.action.SECOND</p>
<p>举例:adb shell am start -n com.lt.test/.MyActivity</p>
<p>startservice [options] <intent> : 启动service通过指定的intent参数。具体intent跟start命令参数相同。</intent></p>
<p>adb shell am startservice [options] <intent></intent></p>
<p>作用:启动一个service</p>
<p>举例:adb shell am startservice -a com.lt.test.action.ONESERVICE<br>举例:adb shell am startservice -n com.lt.test/.MyService</p>
<p>force-stop <package> : 强制停止指定的package包应用。</package></p>
<p>kill [options] <package> :杀死指定package包应用进程，该命令在安全模式下杀死进程，不影响用户体验。参数选项:–user <user_id> | all | current: 指定user进程杀死，如果不指定默认为所有users。（关于USER_ID下面会介绍到）</user_id></package></p>
<p>kill-all :杀死所有的后台进程。</p>
<p>adb shell am force-stop <package><br>作用:强制关闭一个应用程序</package></p>
<p>举例:adb shell am force-stop com.lt.test</p>
<p>broadcast [options] <intent> :发送一个intent。具体intent参数参照start命令参数。参数选项:–user <user_id> | all | current: 指定user进程杀死，如果不指定默认为所有users。</user_id></intent></p>
<p>adb shell am broadcast [options] <intent></intent></p>
<p>作用:发送一个广播<br>举例:adb shell am broadcast -a “action_finish” （发送一个广播去关闭一个activity）<br>举例:adb shell am broadcast -a android.intent.action.MASTER_CLEAR（恢复出厂设置的方法，会清除内存所有内容）</p>
<p>举例:adb shell am broadcast -n com.lt.test/.MyBroadcast</p>
<h1 id="pm命令"><a href="#pm命令" class="headerlink" title="pm命令"></a>pm命令</h1><p>pm全称package manager，你能使用pm命令去模拟android行为或者查询设备上的应用等，当你在adb shell命令下执行pm命令:pm <command><br>你也可以在adb shell前执行pm命令:adb shell pm uninstall com.example.MyApp<br>关于一些pm命令的介绍:<br>list packages [options] <filter> :打印所有包，选择性的查询包列表。</filter></p>
<p>adb shell pm list packages [options] <intent></intent></p>
<p>作用:列举出所有包含<intent>的package</intent></p>
<p>举例:adb shell pm list packages com.lt</p>
<p>说明:[options]与<intent>参见 <a href="http://developer.android.com/tools/help/adb.html#pm" target="_blank" rel="external">http://developer.android.com/tools/help/adb.html#pm</a></intent></p>
<p>参数选项:<br>-f:查看关联文件，即应用apk的位置跟对应的包名（如:package:/system/app /MusicPlayer.apk=com.sec.android.app.music）；</p>
<p>-d:查看disabled packages；</p>
<p>-e:查看enable package；</p>
<p>-s:查看系统package；</p>
<p>-3:查看第三方package；</p>
<p>-i:查看package的对应安装者（如:1、 package:com.tencent.qqmusic installer=null 2、package:com.tencent.qqpim installer=com.android.vending）；</p>
<p>-u:查看曾被卸载过的package。（卸载后又重新安装依然会被列入）；</p>
<p>–user<user_id>:The user space to query。</user_id></p>
<p>list permission-groups :打印所有已知的权限群组。</p>
<p>list permissions [options] <group> :选择性的打印权限。参数选项:</group></p>
<p>list features :设备特性。硬件之类的性能。</p>
<p>list libraries :当前设备支持的libs。</p>
<p>list users :系统上所有的users。（上面提到的USER_ID查询方式，如:UserInfo{0:Primary:3}那么USER_ID为0）</p>
<p>path <package> :查询package的安装位置。</package></p>
<p>install [options] <path></path> :安装命令。</p>
<p>uninstall [options] <package> :卸载命令。</package></p>
<p>clear <package> :对指定的package删除所有数据。</package></p>
<p>enable <package_or_component> :使package或component可用。（如:pm enable “package/class”）</package_or_component></p>
<p>disable <package_or_component> :使package或component不可用。（如:pm disable “package/class”）</package_or_component></p>
<p>disable-user [options] <package_or_component> :参数选项:–user <user_id>: The user to disable.<br>grant <package_permission> :授权给应用。</package_permission></user_id></package_or_component></p>
<p>revoke <package_permission> :撤销权限。</package_permission></p>
<p>set-install-location <location> :设置默认的安装位置。其中0:让系统自动选择最佳的安装位置。1:安装到内部的设备存储空间。2:安装到外部的设备存储空间。（这只用于调试应用程序， 使用该命令可能导致应用程序退出或者其他不适的后果）。</location></p>
<p>get-install-location :返回当前的安装位置。返回结果同上参数选项。</p>
<p>set-permission-enforced <permission> [true|false] :使指定权限生效或者失效。</permission></p>
<p>create-user <user_name> :增加一个新的USER。</user_name></p>
<p>remove-user <user_id> :删除一个USER。</user_id></p>
<p>get-max-users :该设备所支持的最大USER数。（某些设备不支持该命令）</p>
<h1 id="wm命令"><a href="#wm命令" class="headerlink" title="wm命令"></a>wm命令</h1><p>wm全称是window manager，它是对手机分辨率、像素密度、显示区域进行设置的命令。其参数比较少，下面逐条介绍一下该命令的用法。</p>
<p>系统说明:</p>
<p>usage:<br>wm [subcommand] [options]<br>wm size [reset|WxH]<br>wm density [reset|DENSITY]<br>wm overscan [reset|LEFT,TOP,RIGHT,BOTTOM]<br>wm size: return or override display size.<br>wm density: override display density.<br>wm overscan: set overscan area for display.</p>
<p>1、wm size [reset|WxH]</p>
<p>[]内的是可选项。单纯运行wm size命令将会得到lcd本身设置的显示分辨率。</p>
<pre><code>wm size W x H命令是按witch x hight 设置分辨率。如果分辨率设置的过大，图标会变大，反之则变小。设置了分辨率以后执行wm size命令，可以看到LCD本身的分辨率及overwrite的分辨率。
</code></pre><p> wm size reset 命令是将分辨率设置为LCD原始分辨率。</p>
<p>2、 wm density [reset|DENSITY]</p>
<pre><code>该命令的用法类似于wm size 命令，作用是读取、设置或者重置LCD的density值。density值即LCD的ppi.
</code></pre><p>3、 wm overscan [reset|LEFT,TOP,RIGHT,BOTTOM]</p>
<p>  该命令用来设置、重置LCD的显示区域。四个参数分别是显示边缘距离LCD左、上、右、下的像素数。例如，对于分辨率为540x960的屏幕，通过执行 命令wm overscan 0,0,0,420可将显示区域限定在一个540x540的矩形框里。</p>
<p>了解wm可以解决LCD图标大小显示不正常的问题。</p>
<p>但是这些设置都是临时的，适合于调试来确定问题和解决办法。永久性的修改可以参照以下两个办法</p>
<p>法一:</p>
<p>2&gt; adb root    //提示read only filysystem时执行此命令获取root权限，</p>
<p>adb remount</p>
<p>adb pull /system/build.prop D:\</p>
<p>在build.prop末尾添加一行 ro.sf.lcd_density=240 </p>
<p>adb push  D:\build.prop  /system/</p>
<p>adb shell</p>
<p>cd /system/</p>
<p>chmod 644 build.prop    没有修改权限将导致手机起不来</p>
<p>法二: 直接修改system.prop</p>
<p>Y:\xxxx\device\qcom\xxxx\system.prop</p>
<p>ro.sf.lcd_density=240 改这个值，然后重新编译system.img</p>
<blockquote>
<p>注:具体命令的帮助可以输入adb shell am;adb shell pm;adb shell wm;来查看</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">王大可</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">117</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王大可</span>

  

  
</div>




  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.3.8</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
